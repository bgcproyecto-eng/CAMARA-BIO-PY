<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>BIO PY — Identificador de Fauna</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

  <style>
    body {
      margin: 0;
      font-family: "Arial Rounded MT Bold", Arial, sans-serif;
      background: linear-gradient(180deg, #1b4d3e, #134e29);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      margin-top: 1.2rem;
      background: rgba(255,255,255,0.15);
      padding: 12px 28px;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    }
    #camera-area {
      display: none;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
    video {
      width: 90%;
      max-width: 480px;
      border: 3px solid #f5f5dc;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
      background: #000;
    }
    #identify-btn {
      background: #f4a100;
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 1.1rem;
      padding: 14px 28px;
      margin-top: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #identify-btn:active { transform: scale(0.97); }
    #status { margin-top: 12px; font-size: 0.95rem; text-align: center; max-width: 85%; }
    #info-card {
      display: none;
      background: rgba(0,0,0,0.65);
      margin-top: 14px;
      border-radius: 14px;
      padding: 12px;
      width: 90%;
      max-width: 520px;
      text-align: left;
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
    }
    #info-card img {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 10px;
    }
    footer {
      margin-top: auto;
      font-size: 0.9rem;
      opacity: 0.9;
      padding-bottom: 12px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>BIO PY</h1>

  <div id="camera-area">
    <video id="video" autoplay playsinline muted></video>
    <div id="status">Esperando activación...</div>
  </div>

  <button id="identify-btn">IDENTIFICAR ESPECIE</button>

  <div id="info-card">
    <img id="species-img" src="" alt="">
    <h2 id="species-name"></h2>
    <p id="species-desc"></p>
    <div id="confidence"></div>
  </div>

  <footer>Apunta la cámara a un animal o su foto.</footer>

  <script>
    const especies = [
      { id:"jaguar", keys:["jaguar","panthera onca"], nombre:"Jaguar (Panthera onca)", desc:"Felino más grande de América.", img:"https://informesursur.org/wp-content/uploads/2024/05/ramon-vloon-9up5w9nitqw-unsplash-2-scaled.jpg" },
      { id:"tatucarreta", keys:["armadillo","giant armadillo"], nombre:"Tatú carreta (Priodontes maximus)", desc:"Armadillo gigante, excavador.", img:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhl_OStT4E-y42gdEXAy3GojTVg6l1ITowsPbM2_IRvg3uhfAID98lRKC23nkkdXIVP6t4GQaXP533Uo5dOdjMWBhxKwGVekkQj99d0JWnsQwmg7VoG5NKmZvkcphT1fql8cqZZiR_FG_g/s640/tatuCarreta02.jpg" },
      { id:"mykure", keys:["opossum","didelphis"], nombre:"Mykurê (Didelphis albiventris)", desc:"Marsupial común del Paraguay, nocturno y adaptable.", img:"https://pbs.twimg.com/media/EN4AFs0UEAI8TsR.jpg" }
    ];

    const claveMap = [];
    especies.forEach(sp => {
      sp.keysLower = sp.keys.map(k => k.toLowerCase());
      sp.keysLower.forEach(k => claveMap.push({key:k, id:sp.id}));
    });

    const video = document.getElementById("video");
    const statusEl = document.getElementById("status");
    const infoCard = document.getElementById("info-card");
    const speciesImg = document.getElementById("species-img");
    const speciesName = document.getElementById("species-name");
    const speciesDesc = document.getElementById("species-desc");
    const confidenceEl = document.getElementById("confidence");
    const btn = document.getElementById("identify-btn");
    const cameraArea = document.getElementById("camera-area");

    let model = null;
    let analyzeTimer = null;

    async function cargarModelo() {
      statusEl.textContent = "Cargando modelo...";
      model = await mobilenet.load();
      statusEl.textContent = "Modelo cargado. Activando cámara...";
    }

    async function iniciarCamara() {
      try {
        if (location.protocol !== "https:") {
          alert("⚠️ Para usar la cámara en celulares, abrí esta página con HTTPS (https://).");
        }
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" }, width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: false
        });
        video.srcObject = stream;
        cameraArea.style.display = "flex";
        await video.play();
        await new Promise(res => setTimeout(res, 2000)); // Espera 2s para que la cámara se estabilice
        statusEl.textContent = "Cámara activa. Analizando...";
        startAnalisis();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "No se pudo acceder a la cámara. Verifica permisos.";
      }
    }

    function startAnalisis() {
      if (analyzeTimer) clearInterval(analyzeTimer);
      analyzeTimer = setInterval(async () => {
        if (!model) return;
        try {
          const preds = await model.classify(video);
          if (preds && preds.length > 0) {
            // Mostrar las tres predicciones principales
            const resumen = preds.slice(0, 3).map(p => `${p.className} (${(p.probability*100).toFixed(1)}%)`).join(" / ");
            statusEl.textContent = "Predicciones: " + resumen;

            // Buscar coincidencia con especies conocidas
            let encontrado = null;
            for (const p of preds) {
              const texto = p.className.toLowerCase();
              for (const ck of claveMap) {
                if (texto.includes(ck.key)) {
                  encontrado = { sp: especies.find(s => s.id === ck.id), prob: p.probability, label: p.className };
                  break;
                }
              }
              if (encontrado) break;
            }
            if (encontrado) mostrarInfo(encontrado.sp, encontrado.prob, encontrado.label);
          }
        } catch (err) {
          console.error("Error analizando:", err);
        }
      }, 2200);
    }

    function mostrarInfo(sp, prob, label) {
      speciesImg.src = sp.img;
      speciesName.textContent = sp.nombre;
      speciesDesc.textContent = sp.desc;
      confidenceEl.textContent = `Confianza: ${(prob * 100).toFixed(1)}% (${label})`;
      infoCard.style.display = "block";
    }

    btn.addEventListener("click", async () => {
      btn.style.display = "none";
      await cargarModelo();
      await iniciarCamara();
    });

    window.addEventListener("beforeunload", () => {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
      }
    });
  </script>
</body>
</html>
