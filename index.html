<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BIO PY 4.0 — Fauna Paraguay + Genéricos</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>

  <style>
    :root{
      --bg1:#1b4d3e;
      --bg2:#134e29;
      --accent:#f4a100;
      --card-bg:rgba(0,0,0,0.6);
      --muted:#d8ffd8;
    }
    html,body{height:100%;margin:0;font-family:ArialRounded,Arial,Helvetica,sans-serif}
    body{
      display:flex;flex-direction:column;align-items:center;
      background:forestgreen;
      background-size:cover;background-position:center;padding-bottom:36px;
    }
    header{margin-top:36px}
    h1{
      font-size:3rem;letter-spacing:4px;text-shadow:2px 2px 6px #000;
      background:rgba(255,255,255,0.12);padding:10px 28px;border-radius:12px;margin:0;
    }

    main{display:flex;flex-direction:column;align-items:center;width:100%;max-width:980px;padding:12px;margin-top:10px}

    #camera-area{display:none;flex-direction:column;align-items:center;width:100%}
    video{width:86%;max-width:480px;border-radius:12px;border:3px solid #f5f5dc;box-shadow:0 6px 20px rgba(0,0,0,0.6)}
    #status{margin-top:12px;color:var(--muted)}
    #identify-btn{
      margin-top:22px;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:14px 32px;
      font-size:1.05rem;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.45);
    }
    #identify-btn:hover{transform:scale(1.03)}
    #info-card{display:none;margin-top:18px;background:var(--card-bg);border-radius:14px;padding:12px;width:88%;max-width:520px;text-align:left;color:#fff;box-shadow:0 8px 26px rgba(0,0,0,0.5)}
    #info-card .row{display:flex;gap:12px;align-items:flex-start}
    #info-card img{width:40%;max-width:180px;border-radius:10px;object-fit:cover}
    #info-card .meta{flex:1}
    #info-card h2{margin:0;color:#ffd700;font-size:1.25rem}
    #info-card p{margin:8px 0 0 0;line-height:1.25rem;font-size:0.95rem}
    #confidence{margin-top:8px;font-weight:600;color:var(--muted)}
    @media (max-width:520px){
      #info-card .row{flex-direction:column;align-items:center}
      #info-card img{width:90%}
      #info-card .meta{text-align:center}
    }
    footer{margin-top:18px;color:#eaf7e8;font-size:0.9rem;opacity:0.95}
  </style>
</head>
<body>
  <header><h1>BIO PY</h1></header>

  <main>
    <div id="camera-area">
      <video id="video" autoplay playsinline muted ></video>
      <div id="status">Esperando acción...</div>
    </div>

    <div id="info-card" aria-live="polite">
      <div class="row">
        <img id="species-img" src="" alt="imagen especie">
        <div class="meta">
          <h2 id="species-name">Nombre</h2>
          <p id="species-desc">Descripción breve...</p>
          <div id="confidence"></div>
        </div>
      </div>
    </div>

    <button id="identify-btn">IDENTIFICAR ESPECIE</button>

    <footer>
      Apunta la cámara a un animal o foto. 
    </footer>
  </main>

  <script>
    const especies = [
      /* Mamíferos Paraguay */
      { id:"jaguar", keys:["jaguar","panthera onca"], nombre:"Jaguar (Panthera onca)", desc:"Felino más grande de América, depredador tope de selvas y bosques.", img:"https://informesursur.org/wp-content/uploads/2024/05/ramon-vloon-9up5w9nitqw-unsplash-2-scaled.jpg" },
      { id:"tatucarreta", keys:["armadillo","giant armadillo","priodontes"], nombre:"Tatú carreta (Priodontes maximus)", desc:"Armadillo gigante, excavador, en peligro por caza y pérdida de hábitat.", img:"https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhl_OStT4E-y42gdEXAy3GojTVg6l1ITowsPbM2_IRvg3uhfAID98lRKC23nkkdXIVP6t4GQaXP533Uo5dOdjMWBhxKwGVekkQj99d0JWnsQwmg7VoG5NKmZvkcphT1fql8cqZZiR_FG_g/s640/tatuCarreta02.jpg" },
      { id:"mono_aullador", keys:["howler","howler monkey","alouatta"], nombre:"Mono aullador negro (Alouatta caraya)", desc:"Conocido por sus potentes aullidos que se escuchan a kilómetros.", img:"https://www.ecoregistros.org/site/images/dataimages/2017/05/10/202255/mono-aullador--2-.jpg" },
      { id:"tapir", keys:["tapir","tapirus"], nombre:"Tapir (Tapirus terrestris)", desc:"Mayor mamífero terrestre sudamericano; habita bosques y zonas ribereñas.", img:"https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcS38MMx0JQy0ySMuebd3WYCC-1ovf3Gwflxu-LnWYoIGThg2h-ocFB-oG-jC4eLKrXbPUEJRWR23z4sc93jhJ0YndD989Z99AawaFxUghSiJg" },
      { id:"puma", keys:["puma","cougar","mountain lion"], nombre:"Puma (Puma concolor)", desc:"Felino adaptable que controla poblaciones de presas.", img:"https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcT-JiorVXlowBYVHuKzDZDSQ1hotIAtzlHx8qOvioPLTa7W1E19F4xGgGb3XIxNRxTYwy7aSRdx-AUXSH06mWrTQJlGiQ2UtSv8bdrM6Km73A" },
      { id:"aguara_guazu", keys:["maned wolf","chrysocyon","aguara"], nombre:"Aguará guazú (Chrysocyon brachyurus)", desc:"Zorro de patas largas del Chaco y pastizales; especie vulnerable.", img:"https://grupovierci.brightspotcdn.com/dims4/default/494d93f/2147483647/strip/true/crop/600x338+0+11/resize/2000x1126!/format/webp/quality/90/?url=https%3A%2F%2Fk2-prod-grupo-vierci.s3.us-east-1.amazonaws.com%2Fbrightspot%2Fe9%2F96%2Fae9132e3403b91e774d32e94a0cf%2Ft50.jpg" },
      { id:"mykure", keys:["opossum","didelphis","didelphis albiventris","mykure"], nombre:"Mykurê (Didelphis albiventris)", desc:"Marsupial común del Paraguay, nocturno y adaptable a zonas urbanas.", img:"https://pbs.twimg.com/media/EN4AFs0UEAI8TsR.jpg" },
       { id:"pecari", keys:["peccary","pecari","peccary tajacu","tayassu tajacu","wild pig","boar","hairy pig"], nombre:"Pecarí (Pecari tajacu)", desc:"Ungulado que vive en grupos; importante en el ciclo ecológico del monte.", img:"https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcRmKJruImGt2v6QAdbrud2uhSPjvAvIPQdcAvvblcFNKcbVQ7ZFWqyHKsKVEzByhO2h_mkWMBROW7yBBgPVImQop9FMyJLy6uF63teRkizZ"},
      { id:"ciervo_pampas", keys:["marsh deer","ozotoceros","ciervo de las pampas","ozotoceros bezoarticus","deer","gazelle"], nombre:"Ciervo de las pampas (Ozotoceros bezoarticus)", desc:"Cérvido de pastizales y esteros; poblaciones reducidas en algunas zonas.", img:"https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQQXRhyOg10fZUROyXediVK7Jh2ljN-BWHMmIwyQmB-cxN1eFRoHjiTSX5BipnDi5NZGhWdF2Y7ieeqLav1Cdn75Ue3nmcg8XQ9R3D3NHSO"},

      /* Aves Paraguay */
      { id:"guacamayo", keys:["macaw","ara ararauna","parrot"], nombre:"Guacamayo azul y amarillo (Ara ararauna)", desc:"Ave vistosa e importante para la dispersión de semillas.", img:"https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSrLABb8Sr3pp53Nsv6hGaq1zURkl3oiqkHJXyqRNSRCFG4Ip6kcBY0jZK9CwxjPmQp00MMW5ZMXrBvaOHrKD4K0SO0ohG769tPio3341TnPg" },
      { id:"aguila_harpia", keys:["harpy","harpy eagle"], nombre:"Águila harpía (Harpia harpyja)", desc:"Una de las aves rapaces más poderosas del mundo.", img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQLEmEEx2sRt3HuurKxYcAUIgA5SIwrtYnGCp4Jsm3x-UtbsG2ABHaqxnYFv3K1ucekWIN6fjIa8oamH-uMu9RuCq17yUlhzFb7QhABxE9Sbw" },
      { id:"nandu", keys:["rhea","rhea americana"], nombre:"Ñandú (Rhea americana)", desc:"Ave corredora de zonas abiertas, similar al avestruz.", img:"https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcQvkiHmgHRZ2rLnxXPm5GE4K99KcDGfAYE7qEoni-r56M7D6kTxOPFTnYaXkAevUrEUsz3p2hozyOa50XlMFPgeF_jiMm1ZU7OqVbmbByuv" },
      { id:"chaja", keys:["chauna torquata","screamer"], nombre:"Chajá (Chauna torquata)", desc:"Ave ruidosa de humedales y esteros.", img:"https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcT4xNqsWo2OVbX7k_Tua5N2DETVUGH8HddnYmXQoG36HU7PK85ynpzTADe-JTgjYiY08ToUO_PumijY72imM8JD4iDvxwtA_RdgaV1BZlrh" },
      { id:"martin_pescador", keys:["kingfisher","megaceryle torquata"], nombre:"Martín pescador (Megaceryle torquata)", desc:"Ave pescadora visible en ríos y estuarios.", img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR5XLAC0QM7vXtstT4oswq1Ch30kvZ7Ucqwjzkw2o8zKWp6nfaFZFxTL1T4WGBJSrSnNzmppvmJUeSvx8sAJqcLxmCSqrjpwkhPeHumbUeYEg" },

      /* Reptiles Paraguay */
      { id:"yacare", keys:["caiman","yacare"], nombre:"Yacaré (Caiman yacare)", desc:"Caimán común en humedales y ríos del Paraguay.", img:"https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSk_X0Ousj75QzQoyjLF6HkAtcRdOIJAjOFHEKUHi9eEdYuc5J3iE7ci-cVYqxjg97zrI9BtUL5KItrs6KvSwEqv7c60mL9SzX9-noy54a99A" },
      { id:"boa_curiyu", keys:["boa","anaconda","eunectes"], nombre:"Boa curiyú (Eunectes notaeus)", desc:"Boa sudamericana presente en humedales y cursos de agua.", img:"https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcR0OKr0mNhT_7enM3vk1jUIi0r6VBovKu0Qc-saBICr_SCnmNwNpvMDP3omd99GPOnqxLxdERNbwe5S6HdxfDEoKwvi6RkoDbbhYg6WpEsNfA" },
      { id:"tortuga", keys:["turtle","chelonoidis"], nombre:"Tortuga terrestre chaqueña (Chelonoidis chilensis)", desc:"Tortuga terrestre amenazada por pérdida de hábitat.", img:"https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTU9r67NfFXoFMJiQUA3htd4snSNn2E0rT1Vwe0Ua-nGGQdTcsq6vDxEFhoX-BjKPB0LMhAgCTqtbmdmkFxKI3B8h5SSqlQK_qccyrmOJFmww" },

      /* Animales Genéricos Globales */
      { id:"perro", keys:["dog","canis lupus familiaris"], nombre:"Perro (Canis lupus familiaris)", desc:"Animal doméstico y fiel compañero del ser humano.", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Collage_of_Nine_Dogs.jpg/500px-Collage_of_Nine_Dogs.jpg" },
      { id:"gato", keys:["cat","felis catus"], nombre:"Gato (Felis catus)", desc:"Felino doméstico ágil y curioso, popular como mascota.", img:"https://purina.com.py/sites/default/files/2025-09/Conoce-las-razas-de-gatos.jpg" },
      { id:"caballo", keys:["horse","equus caballus"], nombre:"Caballo (Equus ferus caballus)", desc:"Animal de carga y transporte, símbolo de libertad y fuerza.", img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQUw92-RycADJl927VM0u8K0pJWrJk7963V7Q&s" },
      { id:"vaca", keys:["cow","bos taurus"], nombre:"Vaca (Bos taurus)", desc:"Mamífero domesticado productor de leche y carne.", img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSfkhMZAkUKlthC2a_1jMkEhoMzNakBrJcegQ&s" },
      { id:"gallina", keys:["chicken","hen","rooster","gallus gallus domesticus"], nombre:"Gallina (Gallus gallus domesticus)", desc:"Ave de corral domesticada en todo el mundo.", img:"https://agrotendencia.tv/wp-content/uploads/2019/10/agrotendencia-gallina-ponedora-1.jpg.webp" },
      { id:"pato", keys:["duck","anas platyrhynchos"], nombre:"Pato (Anas platyrhynchos domesticus)", desc:"Ave acuática domesticada y silvestre, común en lagos y ríos.", img:"https://www.regmurcia.com/servlet/integra.servlets.Imagenes?METHOD=VERIMAGEN_101949&nombre=Pato_de_granja_Pato_res_720.jpg" },
      { id:"conejo", keys:["rabbit","bunny","oryctolagus cuniculus"], nombre:"Conejo (Oryctolagus cuniculus)", desc:"Pequeño mamífero herbívoro de orejas largas, domesticado.", img:"https://static.nationalgeographicla.com/files/styles/image_3200/public/3897187267_f36b5e4e7a_c.webp?w=1600&h=1200" },
      { id:"leon", keys:["lion","panthera leo"], nombre:"León (Panthera leo)", desc:"Felino africano conocido como el rey de la selva.", img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ_DcVERIPqVuYkSXgEBrzgZBc3vW3etmBzug&s" },
      { id:"elefante", keys:["elephant","loxodonta africana"], nombre:"Elefante africano (Loxodonta africana)", desc:"El mamífero terrestre más grande del mundo.", img:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRtCEdmau3RbpkTMGdxsysYQTMSOLU4G7FXSQ&s" }
    ];

    const claveMap = [];
    especies.forEach(sp => {
      sp.keysLower = sp.keys.map(k => k.toLowerCase());
      sp.keysLower.forEach(k => claveMap.push({key:k, id:sp.id}));
    });

    const btn = document.getElementById('identify-btn');
    const video = document.getElementById('video');
    const cameraArea = document.getElementById('camera-area');
    const status = document.getElementById('status');
    const infoCard = document.getElementById('info-card');
    const speciesImg = document.getElementById('species-img');
    const speciesName = document.getElementById('species-name');
    const speciesDesc = document.getElementById('species-desc');
    const confidenceEl = document.getElementById('confidence');

    let model = null;
    let analyzeTimer = null;

    async function cargarModelo(){
      status.textContent = "Cargando (modelo preentrenado)...";
      model = await mobilenet.load();
      status.textContent = "Modelo cargado. Activá la cámara.";
    }

    async function iniciarCamara() {
      try {
        status.textContent = "Activando cámara...";
        const constraints = {
          audio: false,
          video: { facingMode: { ideal: "environment" }, width: { ideal: 640 }, height: { ideal: 480 } }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        cameraArea.style.display = "flex";
        await video.play();
        status.textContent = "Cámara activa. Analizando...";
        startAnalyzing();
      } catch (err) {
        console.error("Error al acceder a la cámara:", err);
        if (err.name === "NotAllowedError") {
          status.textContent = "Permiso de cámara denegado. Actívalo en la configuración del navegador.";
        } else if (err.name === "NotFoundError") {
          status.textContent = "No se encontró cámara. Verifica tu dispositivo.";
        } else {
          status.textContent = "Error al iniciar cámara: " + err.message;
        }
      }
    }
    function startAnalyzing(){
      if(analyzeTimer) clearInterval(analyzeTimer);
      analyzeTimer = setInterval(async ()=>{
        if(!model) return;
        try{
          const preds = await model.classify(video);
          if(!preds || preds.length===0){ hideInfo(); return; }
          let encontrado = null;
          for(const p of preds){
            const text = p.className.toLowerCase();
            for(const ck of claveMap){
              if(text.includes(ck.key)){
                encontrado = {key:ck.key, id:ck.id, prob:p.probability, label:p.className};
                break;
              }
            }
            if(encontrado) break;
          }
          if(encontrado){
            const sp = especies.find(s=>s.id===encontrado.id);
            if(sp) showInfo(sp, encontrado.probability, preds[0].className);
          } else hideInfo();
        }catch(e){ console.error("Error en predicción:", e); }
      }, 1700);
    }

    function showInfo(sp, prob=0, label=""){
      speciesImg.src = sp.img;
      speciesImg.alt = sp.nombre;
      speciesName.textContent = sp.nombre;
      speciesDesc.textContent = sp.desc;
      confidenceEl.textContent = `Prob. aproximada: ${(prob*100).toFixed(1)}% — etiqueta: ${label}`;
      infoCard.style.display = 'block';
      status.textContent = "Especie detectada";
    }
    function hideInfo(){
      infoCard.style.display = 'none';
      status.textContent = "Analizando...";
    }

    btn.addEventListener('click', async ()=>{
      btn.style.display = 'none';
      await cargarModelo();
      await iniciarCamara();
    });

    window.addEventListener('beforeunload', ()=>{
      if(video && video.srcObject){
        video.srcObject.getTracks().forEach(t=>t.stop());
      }
    });
  </script>
</body>
</html>
